═══════════════════════════════════════════════════════════════════════════
  SQL 脚本文件夹说明
═══════════════════════════════════════════════════════════════════════════

📁 文件夹用途：
  存放临时的 SQL 脚本，用于在 Supabase Dashboard SQL Editor 中执行
  这些文件不会提交到 git（已在 .gitignore 中排除）

⚠️ 重要提示：
  - 这些 SQL 脚本会影响数据库结构和数据
  - 执行前请仔细阅读每个脚本的注释
  - 你的 Supabase 数据库是所有环境共享的（localhost、staging、production）
  - 执行一次 SQL，所有环境都会生效

═══════════════════════════════════════════════════════════════════════════
  📋 文件列表和用途
═══════════════════════════════════════════════════════════════════════════

1️⃣  1-检查当前数据和策略.sql
   ┌─────────────────────────────────────────────────────────────────────┐
   │ 用途：全面检查数据库中的数据和 RLS 策略状态                          │
   │                                                                       │
   │ 包含的检查：                                                          │
   │   ✓ churches 表数据（是否有记录，YouTube 信息是否存在）             │
   │   ✓ oauth_tokens 表数据（Token 是否已加密存储）                     │
   │   ✓ videos 表数据（视频数量统计）                                    │
   │   ✓ 所有表的 RLS 是否启用                                            │
   │   ✓ 所有 RLS 策略详情（是否使用了正确的逻辑）                        │
   │                                                                       │
   │ 执行时机：在修复 RLS 策略之前，或者需要诊断问题时                    │
   │                                                                       │
   │ 如何执行：                                                            │
   │   1. 登录 Supabase Dashboard                                         │
   │      https://supabase.com/dashboard/project/cwiehstggqlxafglkkda    │
   │   2. 左侧菜单 → SQL Editor                                           │
   │   3. 点击 "New query"                                                │
   │   4. 打开这个文件，全选（Ctrl+A），复制（Ctrl+C）                   │
   │   5. 粘贴到 SQL Editor，点击 "Run" 或按 Ctrl+Enter                  │
   │   6. 查看结果，重点关注"策略状态"列                                  │
   │                                                                       │
   │ 预期结果（修复前）：                                                  │
   │   - 策略状态显示 "❌ 有问题（使用旧函数）"                           │
   │   - qual 列显示：(id = get_user_church_id())                        │
   │                                                                       │
   │ 预期结果（修复后）：                                                  │
   │   - 所有策略状态显示 "✅ 已修复（使用 auth.uid）"                    │
   │   - qual 列显示：(id = auth.uid()) 或 (church_id = auth.uid())      │
   └─────────────────────────────────────────────────────────────────────┘


2️⃣  2-修复所有RLS策略.sql
   ┌─────────────────────────────────────────────────────────────────────┐
   │ 用途：修复所有表的 RLS 策略，解决 406 Not Acceptable 错误           │
   │                                                                       │
   │ 问题原因：                                                            │
   │   旧的 RLS 策略使用 get_user_church_id() 函数                        │
   │   这个函数尝试从 user.app_metadata.church_id 读取                    │
   │   但 MVP 设计中用户没有这个字段                                       │
   │   导致函数返回 NULL，查询失败                                         │
   │                                                                       │
   │ 修复方案：                                                            │
   │   MVP 设计是 church.id = user.id（简化的一对一映射）                │
   │   直接使用 auth.uid() 获取当前用户 ID 进行判断                        │
   │                                                                       │
   │ 修复的表：                                                            │
   │   ✓ churches - 教会基本信息表                                        │
   │   ✓ oauth_tokens - OAuth 令牌表                                      │
   │   ✓ videos - 视频表                                                  │
   │   ✓ transcripts - 转录文本表                                         │
   │   ✓ processing_jobs - 处理任务表                                     │
   │                                                                       │
   │ 执行步骤：                                                            │
   │   第一步：删除所有旧的 RLS 策略                                       │
   │   第二步：创建 churches 表的新策略                                    │
   │   第三步：创建 oauth_tokens 表的新策略                                │
   │   第四步：创建 videos 表的新策略                                      │
   │   第五步：创建 transcripts 表的新策略                                 │
   │   第六步：创建 processing_jobs 表的新策略                             │
   │   第七步：验证修复结果                                                │
   │                                                                       │
   │ 如何执行：                                                            │
   │   1. 确保已经执行过 "1-检查当前数据和策略.sql" 并确认有问题         │
   │   2. 登录 Supabase Dashboard → SQL Editor                            │
   │   3. 打开这个文件，全选（Ctrl+A），复制（Ctrl+C）                   │
   │   4. 粘贴到 SQL Editor，点击 "Run" 或按 Ctrl+Enter                  │
   │   5. 查看最后的验证结果                                               │
   │                                                                       │
   │ 执行时机：                                                            │
   │   当出现以下问题时执行：                                              │
   │   - 前端显示 406 Not Acceptable 错误                                 │
   │   - 浏览器控制台显示 "Church record found: false"                    │
   │   - 检查脚本显示策略状态为 "❌ 有问题"                              │
   │                                                                       │
   │ 预期结果：                                                            │
   │   验证查询应该显示所有策略状态为 "✅ 已修复"                         │
   │                                                                       │
   │ 执行后：                                                              │
   │   1. 刷新浏览器 http://localhost:8000                                │
   │   2. 应该可以看到 YouTube 连接成功                                    │
   │   3. 显示 "View Videos" 按钮                                         │
   │   4. 浏览器控制台不再显示 406 错误                                    │
   └─────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════
  ⚠️ 注意事项
═══════════════════════════════════════════════════════════════════════════

1. 数据库环境：
   - 你目前只有一个 Supabase 数据库
   - 这个数据库被所有环境共享：
     * localhost:8000 (本地开发)
     * Vercel staging URL (测试环境)
     * Vercel production URL (生产环境，如果部署了)
   - 执行 SQL 后，所有环境立即生效
   - 不需要在多个环境重复执行

2. 执行顺序：
   - 必须先执行 "1-检查当前数据和策略.sql" 了解现状
   - 确认有问题后，再执行 "2-修复所有RLS策略.sql"
   - 不要跳过检查步骤直接修复

3. 安全性：
   - 这些脚本只修改 RLS 策略，不会删除数据
   - 如果执行失败，旧策略会保留（使用 DROP IF EXISTS）
   - 可以安全地重复执行修复脚本

4. 如何撤销：
   - 如果需要恢复旧策略，执行原始的 002_rls_policies.sql
   - 位置：supabase/migrations/002_rls_policies.sql

═══════════════════════════════════════════════════════════════════════════
  📚 相关文档
═══════════════════════════════════════════════════════════════════════════

详细的 OAuth 流程说明：
  docs/YOUTUBE_OAUTH_WALKTHROUGH.md

原始的 RLS 策略定义：
  supabase/migrations/002_rls_policies.sql

修复后的策略定义：
  supabase/migrations/005_fix_rls_policies.sql

═══════════════════════════════════════════════════════════════════════════
  💡 常见问题
═══════════════════════════════════════════════════════════════════════════

Q: 为什么会出现 406 Not Acceptable 错误？
A: 旧的 RLS 策略使用 get_user_church_id() 函数查找 app_metadata.church_id，
   但用户的 metadata 中没有这个字段，导致函数返回 NULL，查询条件变成
   WHERE id = NULL，永远返回 0 行，Supabase 返回 PGRST116 错误。

Q: 为什么修复后使用 auth.uid()？
A: MVP 的设计是 church.id = user.id（一对一映射），所以可以直接使用
   auth.uid() 获取当前用户 ID 来判断权限，不需要额外的 metadata。

Q: 这个修复会影响多租户隔离吗？
A: 不会。修复后的策略仍然确保每个用户只能访问自己的数据。
   churches 表：WHERE id = auth.uid()
   其他表：WHERE church_id = auth.uid()
   这样每个用户仍然被限制在自己的 church 范围内。

Q: 如果以后改为一个用户管理多个 church 怎么办？
A: 那时需要：
   1. 在 user.app_metadata 中添加 church_id
   2. 恢复使用 get_user_church_id() 函数
   3. 创建 church_members 中间表
   但目前 MVP 阶段不需要这么复杂。

═══════════════════════════════════════════════════════════════════════════
